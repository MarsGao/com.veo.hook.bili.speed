name: Build Android APK

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'  # è§¦å‘ tag å‘å¸ƒ (å¦‚ v1.1.8)
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Generate debug keystore
      run: |
        mkdir -p ~/.android
        keytool -genkey -dname "cn=Android Debug, ou=Android, o=Google, l=Unknown, st=Unknown, c=US" \
          -keystore ~/.android/debug.keystore \
          -storepass android \
          -alias androiddebugkey \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -keypass android

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Get version from gradle.properties
      id: version
      run: |
        VERSION=$(grep "appVersionName" gradle.properties | cut -d'=' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Build debug APK
      run: ./gradlew assembleDebug --no-daemon

    - name: Rename APK with version
      run: |
        VERSION=${{ steps.version.outputs.version }}
        mkdir -p release
        cp app/build/outputs/apk/debug/app-debug.apk release/biliSpeed_${VERSION}.apk
        echo "APK renamed to: biliSpeed_${VERSION}.apk"

    - name: Upload debug APK (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: biliSpeed_${{ steps.version.outputs.version }}
        path: release/biliSpeed_${{ steps.version.outputs.version }}.apk

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        name: biliSpeed v${{ steps.version.outputs.version }}
        body: |
          ## biliSpeed v${{ steps.version.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½
          - **biliSpeed_${{ steps.version.outputs.version }}.apk** - Android APK å®‰è£…åŒ…
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹æäº¤å†å²è·å–è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ### âš ï¸ æ³¨æ„
          - éœ€è¦ Android 8.0 (API 26) æˆ–æ›´é«˜ç‰ˆæœ¬
          - éœ€è¦ LSPosed/Xposed æ¡†æ¶æ”¯æŒ
        files: |
          release/biliSpeed_${{ steps.version.outputs.version }}.apk
        generate_release_notes: true
        draft: false
        token: ${{ secrets.GITHUB_TOKEN }}
